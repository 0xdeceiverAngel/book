# Practical Malware Analysis
## ch 1
- use virustotal
- string 看字串
- 查hash
- 加殼
    + 會用到 LoadLibrary and Get processAddress 
- PEiD
- 導入表
- 動態連結 靜態連結 執行時連結
- dependency walker 靜態連結函數,dll export
- 函數結尾 Ex A=ascii W=wide char
- rdata 函數資料 或是存在idata edata
- rsrc 
- imgae_file_header show cli or gui
### tools
- peview
- dependency walker
- PE explorer
- PEBrowse pro
## ch 2
intro to vm
## ch 3
- 基礎動態分析
    - sandbox
- rundll32 
- net start service or sc
- process explorer 
- process monitor
- process replacement
- regshot
- apateDNS
- netcat
- wireshark
- INetsim

### lab03-01

看影片

一開始有看到是被加入junk code

ApateDNS 看到想要連`www.practicalmalwareanalysis.com`

用到的dll 可以連網路
- ws2_32.dll
- wshtcp_ip.dll

regshot看reg被改了啥
```
新添加值 (4) 快照 B 
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]                  #開機啟動
"VideoDriver"="C:\\WINDOWS\\system32\\vmx32to64.exe"                                #感染videodriver
[HKEY_CURRENT_USER\Software\Sysinternals\Process Monitor] 
"FilterDialog"=hex:2c,00,00,00,00,00,00,00,01,00,00,00,ff,ff,ff,ff,ff,ff,ff,ff,\
  ff,ff,ff,ff,ff,ff,ff,ff,e1,01,00,00,91,01,00,00,e0,03,00,00,c2,02,00,00 
"FilterControlColumns"=hex:64,00,00,00,64,00,00,00,64,00,00,00,64,00,00,00,00,\
  00,00,00,01,00,00,00,02,00,00,00,03,00,00,00 
"PropertySheetDialog"=hex:2c,00,00,00,00,00,00,00,01,00,00,00,ff,ff,ff,ff,ff,\
  ff,ff,ff,ff,ff,ff,ff,ff,ff,ff,ff,e4,00,00,00,b9,00,00,00,d4,02,00,00,f8,02,\
  00,00 
  
已改變值 (24) 快照 A 
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\RNG]                              #應該是key
"Seed"=hex:3f,ab,27,7e,9f,2c,38,f2,46,24,35,29,f0,d8,07,ee,48,76,75,bb,17,b3,\
  4e,f1,bb,75,c0,37,78,73,b5,23,d9,00,19,30,43,64,9e,b8,6f,ef,97,4a,63,09,4f,\
  ca,57,e9,c6,46,34,c1,41,7b,21,16,9e,68,d7,55,f3,fa,ac,6a,73,15,ca,40,7d,2a,\
  01,01,dc,ef,38,2b,6b,0b 
"Seed"=hex:f3,68,d8,b8,aa,29,c5,ab,eb,87,9c,fe,7c,c4,bd,08,01,ce,03,56,22,06,\
  34,d5,a0,d2,bf,52,17,91,bd,fc,64,d3,35,f3,b7,96,9a,db,9e,41,74,17,af,fe,0f,\
  02,06,01,91,f8,bd,4f,4e,36,e5,1a,8b,38,d8,81,58,67,58,b2,ea,94,5c,c3,2e,60,\
  34,7c,f9,f0,d7,f5,e9,21 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Dhcp\Parameters] 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,7b,2d,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,7b,2d,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,7b,2d,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,7b,2d,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,7b,2d,99,60,c0,a8,99,fe,35,... 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,3c,2e,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,3c,2e,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,3c,2e,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,3c,2e,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,3c,2e,99,60,c0,a8,99,fe,35,... 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\RemoteAccess\Performance] 
"Error Count"=dword:00000166 
"Error Count"=dword:00000210 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\SharedAccess\Epoch] 
"Epoch"=dword:00000030 
"Epoch"=dword:00000032 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Tcpip\Parameters\Interfaces\{C8083C58-2F00-4248-AE6E-24A6FEC26082}] 
"LeaseObtainedTime"=dword:604617f3 
"LeaseObtainedTime"=dword:604618b4 
"T1"=dword:606fa2b7 
"T1"=dword:606fa378 
"T2"=dword:608ecaca 
"T2"=dword:608ecb8b 
"LeaseTerminatesTime"=dword:60992d7b 
"LeaseTerminatesTime"=dword:60992e3c 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\{C8083C58-2F00-4248-AE6E-24A6FEC26082}\Parameters\Tcpip] 
"LeaseObtainedTime"=dword:604617f3 
"LeaseObtainedTime"=dword:604618b4 
"T1"=dword:606fa2b7 
"T1"=dword:606fa378 
"T2"=dword:608ecaca 
"T2"=dword:608ecb8b 
"LeaseTerminatesTime"=dword:60992d7b 
"LeaseTerminatesTime"=dword:60992e3c 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Dhcp\Parameters] 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,7b,2d,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,7b,2d,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,7b,2d,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,7b,2d,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,7b,2d,99,60,c0,a8,99,fe,35,... 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,3c,2e,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,3c,2e,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,3c,2e,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,3c,2e,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,3c,2e,99,60,c0,a8,99,fe,35,... 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RemoteAccess\Performance] 
"Error Count"=dword:00000166 
"Error Count"=dword:00000216 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Epoch] 
"Epoch"=dword:00000030 
"Epoch"=dword:00000032 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\{C8083C58-2F00-4248-AE6E-24A6FEC26082}] 
"LeaseObtainedTime"=dword:604617f3 
"LeaseObtainedTime"=dword:604618b4 
"T1"=dword:606fa2b7 
"T1"=dword:606fa378 
"T2"=dword:608ecaca 
"T2"=dword:608ecb8b 
"LeaseTerminatesTime"=dword:60992d7b 
"LeaseTerminatesTime"=dword:60992e3c 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\{C8083C58-2F00-4248-AE6E-24A6FEC26082}\Parameters\Tcpip] 
"LeaseObtainedTime"=dword:604617f3 
"LeaseObtainedTime"=dword:604618b4 
"T1"=dword:606fa2b7 
"T1"=dword:606fa378 
"T2"=dword:608ecaca 
"T2"=dword:608ecb8b 
"LeaseTerminatesTime"=dword:60992d7b 
"LeaseTerminatesTime"=dword:60992e3c 
[HKEY_CURRENT_USER\SessionInformation] 
"ProgramCount"=dword:00000006 
"ProgramCount"=dword:00000007 
  

```
然後process monitor 有看到寫一個檔案`C:\WINDOWS\system32\vmx32to64.exe`

mutant避免重複感染

可以發現lab03-01就是wmx32to64.exe

### lab03-02

給你一個dll

先用pe explorer看dll接口

跑`rundll32 Lab03-02.dll install` 

看reg紀錄會發現，新增一個服務

跑`net start IPRIP` 

它就會開始戳網站

```
已刪除鍵 (2) 快照 A 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\PROCMON24\Enum] 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PROCMON24\Enum] 
  
新添加鍵 (7) 快照 B 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\IPRIP] 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP] 
[HKEY_CURRENT_USER\Software\Microsoft\Dependency Walker\Recent File List] 
  
已刪除值 (6) 快照 A 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\PROCMON24\Enum] 
"0"="Root\\LEGACY_PROCMON24\\0000" 
"Count"=dword:00000001 
"NextInstance"=dword:00000001 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\PROCMON24\Enum] 
"0"="Root\\LEGACY_PROCMON24\\0000" 
"Count"=dword:00000001 
"NextInstance"=dword:00000001 
  
新添加值 (20) 快照 B 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\IPRIP] 
"Type"=dword:00000020 
"Start"=dword:00000002 
"ErrorControl"=dword:00000001 
"ImagePath"=hex(2):25,00,53,00,79,00,73,00,74,00,65,00,6d,00,52,00,6f,00,6f,00,\
  74,00,25,00,5c,00,53,00,79,00,73,00,74,00,65,00,6d,00,33,00,32,00,5c,00,73,\
  00,76,00,63,00,68,00,6f,00,73,00,74,00,2e,00,65,00,78,00,65,00,20,00,2d,00,\
  6b,00,20,00,6e,00,65,00,74,00,73,00,76,00,63,00,73,00,00,00 
"DisplayName"="Intranet Network Awareness (INA+)" 
"ObjectName"="LocalSystem" 
"Description"="Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes." 
"DependOnService"=hex(7):52,00,70,00,63,00,53,00,73,00,00,00,00,00 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\IPRIP\Parameters] 
"ServiceDll"=hex(2):43,00,3a,00,5c,00,44,00,6f,00,63,00,75,00,6d,00,65,00,6e,\
  00,74,00,73,00,20,00,61,00,6e,00,64,00,20,00,53,00,65,00,74,00,74,00,69,00,\
  6e,00,67,00,73,00,5c,00,41,00,64,00,6d,00,69,00,6e,00,69,00,73,00,74,00,72,\
  00,61,00,74,00,6f,00,72,00,5c,00,4c,68,62,97,5c,00,42,00,69,00,6e,00,61,00,\
  72,00,79,00,43,00,6f,00,6c,00,6c,00,65,00,63,00,74,00,69,00,6f,00,6e,00,5c,\
  00,43,00,68,00,61,00,70,00,74,... 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\IPRIP\Security] 
"Security"=hex:01,00,14,80,90,00,00,00,9c,00,00,00,14,00,00,00,30,00,00,00,02,\
  00,1c,00,01,00,00,00,02,80,14,00,ff,01,0f,00,01,01,00,00,00,00,00,01,00,00,\
  00,00,02,00,60,00,04,00,00,00,00,00,14,00,fd,01,02,00,01,01,00,00,00,00,00,\
  05,12,00,00,00,00,00,18,00,ff,01,0f,00,01,02,00,00,00,00,00,05,20,00,00,00,\
  20,02,00,00,00,00,14,00,8d,01,02,00,01,01,00,00,00,00,00,05,0b,00,00,00,00,\
  00,18,00,fd,01,02,00,01,... 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP] 
"Type"=dword:00000020 
"Start"=dword:00000002 
"ErrorControl"=dword:00000001 
"ImagePath"=hex(2):25,00,53,00,79,00,73,00,74,00,65,00,6d,00,52,00,6f,00,6f,00,\
  74,00,25,00,5c,00,53,00,79,00,73,00,74,00,65,00,6d,00,33,00,32,00,5c,00,73,\
  00,76,00,63,00,68,00,6f,00,73,00,74,00,2e,00,65,00,78,00,65,00,20,00,2d,00,\
  6b,00,20,00,6e,00,65,00,74,00,73,00,76,00,63,00,73,00,00,00 
"DisplayName"="Intranet Network Awareness (INA+)" 
"ObjectName"="LocalSystem" 
"Description"="Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes." 
"DependOnService"=hex(7):52,00,70,00,63,00,53,00,73,00,00,00,00,00 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters] 
"ServiceDll"=hex(2):43,00,3a,00,5c,00,44,00,6f,00,63,00,75,00,6d,00,65,00,6e,\
  00,74,00,73,00,20,00,61,00,6e,00,64,00,20,00,53,00,65,00,74,00,74,00,69,00,\
  6e,00,67,00,73,00,5c,00,41,00,64,00,6d,00,69,00,6e,00,69,00,73,00,74,00,72,\
  00,61,00,74,00,6f,00,72,00,5c,00,4c,68,62,97,5c,00,42,00,69,00,6e,00,61,00,\
  72,00,79,00,43,00,6f,00,6c,00,6c,00,65,00,63,00,74,00,69,00,6f,00,6e,00,5c,\
  00,43,00,68,00,61,00,70,00,74,... 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP\Security] 
"Security"=hex:01,00,14,80,90,00,00,00,9c,00,00,00,14,00,00,00,30,00,00,00,02,\
  00,1c,00,01,00,00,00,02,80,14,00,ff,01,0f,00,01,01,00,00,00,00,00,01,00,00,\
  00,00,02,00,60,00,04,00,00,00,00,00,14,00,fd,01,02,00,01,01,00,00,00,00,00,\
  05,12,00,00,00,00,00,18,00,ff,01,0f,00,01,02,00,00,00,00,00,05,20,00,00,00,\
  20,02,00,00,00,00,14,00,8d,01,02,00,01,01,00,00,00,00,00,05,0b,00,00,00,00,\
  00,18,00,fd,01,02,00,01,... 
  
已改變值 (54) 快照 A 
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\RNG] 
"Seed"=hex:af,93,31,83,c2,95,3d,7d,8f,76,91,fa,a0,df,70,b0,ef,2a,ca,3a,dd,d4,\
  fc,2f,44,63,45,c6,f1,c4,e8,f7,4e,b4,3d,54,49,45,72,a0,5c,fc,92,4d,dd,8a,59,\
  dc,11,51,14,dd,39,2a,a6,1a,10,79,4f,37,e5,2b,4d,31,d0,69,dd,84,81,06,ba,cc,\
  a0,51,19,bb,ab,51,21,46 
"Seed"=hex:73,a7,37,3a,6d,ec,31,f4,b1,fe,6d,03,5e,f0,01,db,f6,3c,c9,a5,b2,86,\
  a6,3e,ca,16,19,b9,6e,74,a3,ce,9a,b8,c3,4e,37,8d,32,52,04,30,78,5d,f4,ac,2b,\
  b2,a7,df,68,6f,9e,6c,07,b5,b5,10,0c,f7,7f,29,bf,2c,a0,91,10,25,08,b5,c0,60,\
  21,4d,3d,b8,3f,ad,5f,62 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class\{4D36E96C-E325-11CE-BFC1-08002BE10318}\0000\Settings] 
"LineOutVol_Left"=dword:fff3fff6 
"LineOutVol_Left"=dword:fff61a63 
"LineOutVol_Right"=dword:fff3fff6 
"LineOutVol_Right"=dword:fff61a63 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\DeviceClasses\{6994AD04-93EF-11D0-A3CC-00A0C9223196}\##?#PCI#VEN_1274&DEV_1371&SUBSYS_13711274&REV_02#4&47B7341&0&1088#{6994ad04-93ef-11d0-a3cc-00a0c9223196}\#Wave\Device Parameters\Mixer\       0\Controls\       0] 
"Channel       0"=dword:0000404d 
"Channel       0"=dword:000051eb 
"Channel       1"=dword:0000404d 
"Channel       1"=dword:000051eb 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Video\{135978FE-028E-4F76-8108-941683B9C0E0}\0000] 
"Resolution.KVM"="1914x966" 
"Resolution.KVM"="1920x1080" 
"Resolution.KVM.0"="1914x966" 
"Resolution.KVM.0"="1920x1080" 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Video\{135978FE-028E-4F76-8108-941683B9C0E0}\0001] 
"Resolution.KVM"="1914x966" 
"Resolution.KVM"="1920x1080" 
"Resolution.KVM.0"="1914x966" 
"Resolution.KVM.0"="1920x1080" 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Hardware Profiles\0001\System\CurrentControlSet\Control\VIDEO\{135978FE-028E-4F76-8108-941683B9C0E0}\0000] 
"DefaultSettings.XResolution"=dword:0000077a 
"DefaultSettings.XResolution"=dword:00000780 
"DefaultSettings.YResolution"=dword:000003c6 
"DefaultSettings.YResolution"=dword:00000438 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Hardware Profiles\Current\System\CurrentControlSet\Control\VIDEO\{135978FE-028E-4F76-8108-941683B9C0E0}\0000] 
"DefaultSettings.XResolution"=dword:0000077a 
"DefaultSettings.XResolution"=dword:00000780 
"DefaultSettings.YResolution"=dword:000003c6 
"DefaultSettings.YResolution"=dword:00000438 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Dhcp\Parameters] 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,19,63,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,19,63,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,19,63,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,19,63,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,19,63,99,60,c0,a8,99,fe,35,... 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,6e,63,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,6e,63,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,6e,63,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,6e,63,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,6e,63,99,60,c0,a8,99,fe,35,... 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\RemoteAccess\Performance] 
"Error Count"=dword:000001a9 
"Error Count"=dword:000003d4 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\SharedAccess\Epoch] 
"Epoch"=dword:00000037 
"Epoch"=dword:00000039 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Tcpip\Parameters\Interfaces\{C8083C58-2F00-4248-AE6E-24A6FEC26082}] 
"NameServer"="" 
"NameServer"="127.0.0.1" 
"LeaseObtainedTime"=dword:60464d91 
"LeaseObtainedTime"=dword:60464de6 
"T1"=dword:606fd855 
"T1"=dword:606fd8aa 
"T2"=dword:608f0068 
"T2"=dword:608f00bd 
"LeaseTerminatesTime"=dword:60996319 
"LeaseTerminatesTime"=dword:6099636e 
"DhcpRetryTime"=dword:00298ac2 
"DhcpRetryTime"=dword:00298ac4 
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\{C8083C58-2F00-4248-AE6E-24A6FEC26082}\Parameters\Tcpip] 
"LeaseObtainedTime"=dword:60464d91 
"LeaseObtainedTime"=dword:60464de6 
"T1"=dword:606fd855 
"T1"=dword:606fd8aa 
"T2"=dword:608f0068 
"T2"=dword:608f00bd 
"LeaseTerminatesTime"=dword:60996319 
"LeaseTerminatesTime"=dword:6099636e 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Class\{4D36E96C-E325-11CE-BFC1-08002BE10318}\0000\Settings] 
"LineOutVol_Left"=dword:fff3fff6 
"LineOutVol_Left"=dword:fff61a63 
"LineOutVol_Right"=dword:fff3fff6 
"LineOutVol_Right"=dword:fff61a63 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceClasses\{6994AD04-93EF-11D0-A3CC-00A0C9223196}\##?#PCI#VEN_1274&DEV_1371&SUBSYS_13711274&REV_02#4&47B7341&0&1088#{6994ad04-93ef-11d0-a3cc-00a0c9223196}\#Wave\Device Parameters\Mixer\       0\Controls\       0] 
"Channel       0"=dword:0000404d 
"Channel       0"=dword:000051eb 
"Channel       1"=dword:0000404d 
"Channel       1"=dword:000051eb 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Video\{135978FE-028E-4F76-8108-941683B9C0E0}\0000] 
"Resolution.KVM"="1914x966" 
"Resolution.KVM"="1920x1080" 
"Resolution.KVM.0"="1914x966" 
"Resolution.KVM.0"="1920x1080" 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Video\{135978FE-028E-4F76-8108-941683B9C0E0}\0001] 
"Resolution.KVM"="1914x966" 
"Resolution.KVM"="1920x1080" 
"Resolution.KVM.0"="1914x966" 
"Resolution.KVM.0"="1920x1080" 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Hardware Profiles\0001\System\CurrentControlSet\Control\VIDEO\{135978FE-028E-4F76-8108-941683B9C0E0}\0000] 
"DefaultSettings.XResolution"=dword:0000077a 
"DefaultSettings.XResolution"=dword:00000780 
"DefaultSettings.YResolution"=dword:000003c6 
"DefaultSettings.YResolution"=dword:00000438 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Hardware Profiles\Current\System\CurrentControlSet\Control\VIDEO\{135978FE-028E-4F76-8108-941683B9C0E0}\0000] 
"DefaultSettings.XResolution"=dword:0000077a 
"DefaultSettings.XResolution"=dword:00000780 
"DefaultSettings.YResolution"=dword:000003c6 
"DefaultSettings.YResolution"=dword:00000438 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Dhcp\Parameters] 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,19,63,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,19,63,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,19,63,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,19,63,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,19,63,99,60,c0,a8,99,fe,35,... 
"{C8083C58-2F00-4248-AE6E-24A6FEC26082}"=hex:06,00,00,00,00,00,00,00,04,00,00,\
  00,00,00,00,00,6e,63,99,60,c0,a8,99,01,0f,00,00,00,00,00,00,00,0b,00,00,00,\
  00,00,00,00,6e,63,99,60,6c,6f,63,61,6c,64,6f,6d,61,69,6e,00,01,00,00,00,00,\
  00,00,00,04,00,00,00,00,00,00,00,6e,63,99,60,ff,ff,ff,00,33,00,00,00,00,00,\
  00,00,04,00,00,00,00,00,00,00,6e,63,99,60,00,53,15,88,36,00,00,00,00,00,00,\
  00,04,00,00,00,00,00,00,00,6e,63,99,60,c0,a8,99,fe,35,... 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RemoteAccess\Performance] 
"Error Count"=dword:000001a9 
"Error Count"=dword:000003d7 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Epoch] 
"Epoch"=dword:00000037 
"Epoch"=dword:00000039 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces\{C8083C58-2F00-4248-AE6E-24A6FEC26082}] 
"NameServer"="" 
"NameServer"="127.0.0.1" 
"LeaseObtainedTime"=dword:60464d91 
"LeaseObtainedTime"=dword:60464de6 
"T1"=dword:606fd855 
"T1"=dword:606fd8aa 
"T2"=dword:608f0068 
"T2"=dword:608f00bd 
"LeaseTerminatesTime"=dword:60996319 
"LeaseTerminatesTime"=dword:6099636e 
"DhcpRetryTime"=dword:00298ac2 
"DhcpRetryTime"=dword:00298ac4 
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\{C8083C58-2F00-4248-AE6E-24A6FEC26082}\Parameters\Tcpip] 
"LeaseObtainedTime"=dword:60464d91 
"LeaseObtainedTime"=dword:60464de6 
"T1"=dword:606fd855 
"T1"=dword:606fd8aa 
"T2"=dword:608f0068 
"T2"=dword:608f00bd 
"LeaseTerminatesTime"=dword:60996319 
"LeaseTerminatesTime"=dword:6099636e 
[HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\Desktop\Components\0] 
"Position"=hex:2c,00,00,00,98,00,00,00,00,00,00,00,e2,06,00,00,a8,03,00,00,00,\
  00,00,00,01,00,00,00,01,00,00,00,01,00,00,00,00,00,00,00,00,00,00,00 
"Position"=hex:2c,00,00,00,98,00,00,00,00,00,00,00,e8,06,00,00,1a,04,00,00,00,\
  00,00,00,01,00,00,00,01,00,00,00,01,00,00,00,00,00,00,00,00,00,00,00 
[HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\TaskManager] 
"Preferences"=hex:9c,02,00,00,f4,01,00,00,02,00,00,00,01,00,00,00,00,00,00,00,\
  62,01,00,00,51,00,00,00,f6,02,00,00,fa,01,00,00,02,00,00,00,00,00,00,00,02,\
  00,00,00,03,00,00,00,04,00,00,00,ff,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,... 
"Preferences"=hex:9c,02,00,00,f4,01,00,00,02,00,00,00,01,00,00,00,00,00,00,00,\
  40,00,00,00,b1,01,00,00,d4,01,00,00,5a,03,00,00,02,00,00,00,00,00,00,00,02,\
  00,00,00,03,00,00,00,04,00,00,00,ff,ff,ff,ff,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\
  00,00,00,00,00,00,00,00,00,... 
[HKEY_CURRENT_USER\SessionInformation] 
"ProgramCount"=dword:00000001 
"ProgramCount"=dword:00000008 

```

### lab03-03

發現它會開啟svchost 然後把memory 改掉

映射成keylogger 看api 和 procmon 就可以看到一直讀寫

### lab03-04
strings 裡有 del

開起來之後會發現自己呼叫cmd /c del關掉自己 留下`conime.exe`


## ch4
```
mov eax,ecx 
mov eax,[ebx+esi*4]     #對
mov eax,ebx+esi*4       #錯
lea eax,ebx+8 == mov [eax,ebx+8]
mul 0x50                #把eax*0x50 save to edx:eax
div 0x75                #edx:eax div 0x75 save quotient to eax,remainder to edx
xor eax,eax             #設成0
shr shl
ror rol                 #循環向左右移動位元
nop == xchg eax,eax
```
lea 也會被拿來計算用
位元左右移動 拿來當乘除法

| addr |    | 由上往下長|
| -------- | -------- |--|
| ebp    | high    |1|
| esp    | low    |2|

```
push 壓參數
call memory_loaction 把eip壓進去  eip 射程memory_location(函數開始位置)
壓ebp
執行func
leave 恢復ebp
ret pop eip
```
pop eax esp會減小
pusha pushad 將所有register取出或壓入

test 設定flag zf 

|cmp dst,src|zf|cf|
|-|-| -|
|dst==src|1|0|
|dst<src|0|1|
|dst>src|0|0|

## ch5
ida pro
### lab05-01

1. What is the address of DllMain
![](https://i.imgur.com/d0kTrX9.jpg)
2. Use the Imports window to browse to gethostbyname . Where is the import located?
![](https://i.imgur.com/EAAdNgN.jpg)
3. How many functions call gethostbyname ?
![](https://i.imgur.com/giq7Vj0.jpg)

4. Focusing on the call to gethostbyname located at 0x10001757, can you figure out which DNS request will be made?
![](https://i.imgur.com/qwtWX2r.jpg)

5. How many local variables has IDA Pro recognized for the subroutine at 0x10001656?
![](https://i.imgur.com/zj5nk6P.jpg)
6. How many parameters has IDA Pro recognized for the subroutine at 0x10001656?
![](https://i.imgur.com/zj5nk6P.jpg)

7. Use the Strings window to locate the string \cmd.exe /c in the disassembly.Where is it located?
![](https://i.imgur.com/AYp3vII.jpg)

8. What is happening in the area of code that references \cmd.exe /c ?
![](https://i.imgur.com/DsnmqYn.jpg)

會發現開啟remote shell 然後等待指令
9.  In the same area, at 0x100101C8, it looks like dword_1008E5C4 is a global variable that helps decide which path to take. How does the malware set dword_1008E5C4 ? (Hint: Use dword_1008E5C4 ’s cross-references.)
被sub_10001656+22 設定值
![](https://i.imgur.com/v8vDf9p.jpg)
![](https://i.imgur.com/ZAgXQdt.jpg)
![](https://i.imgur.com/nMQbFRH.jpg)
call GetVersionExA
10. A few hundred lines into the subroutine at 0x1000FF58, a series of comparisons use memcmp to compare strings. What happens if the string comparison to robotwork is successful (when memcmp returns 0)?
![](https://i.imgur.com/cbncQNk.jpg)
![](https://i.imgur.com/jCGPJ2v.jpg)
![](https://i.imgur.com/sZ3uY5W.jpg)

找到`robotwork` 如果驗證有過就 push [ebp+s]、call sub_100052A2

它就會打開設定register key，print 出來

11.  What does the export PSLIST do?
主要來講就是check windows 版本
然後做比較 ....有點長 懶得打
12. Use the graph mode to graph the cross-references from sub_10004E79.Which API functions could be called by entering this function? Based on the API functions alone, what could you rename this function?
![](https://i.imgur.com/tub6WID.jpg)
13. How many Windows API functions does DllMain call directly? How many at a depth of 2?
![](https://i.imgur.com/uahg4e0.jpg)
14. 14. At 0x10001358, there is a call to Sleep (an API function that takes one parameter containing the number of milliseconds to sleep). Looking backward through the code, how long will the program sleep if this code executes?
![](https://i.imgur.com/0GCbExD.jpg)
字串atoi後變成30

sleep(30*1000)==sleep 30分鐘
15. At 0x10001701 is a call to socket . What are the three parameters?
![](https://i.imgur.com/w8bHA3X.jpg)

17. Search for usage of the in instruction (opcode 0xED ). This instruction is used with a magic string VMXh to perform VMware detection. Is that in use in this malware? Using the cross-references to the function that executes the in instruction, is there further evidence of VMware detection?
![](https://i.imgur.com/NSRdV5h.jpg)
## ch6
先分組
### global and local var
```c
#include<stdio.h>
int k=2;
int r=2;
int main()
{
	int x=1;
	int y=1;
	__asm__("nop");
	r=23;
	printf("%d\n",x+y);
	printf("%d",r+k);
}

```
```
.text:0000000000401530 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:0000000000401530                 public main
.text:0000000000401530 main            proc near               ; CODE XREF: __tmainCRTStartup+233↑p
.text:0000000000401530
.text:0000000000401530 y               = dword ptr -8
.text:0000000000401530 x               = dword ptr -4
.text:0000000000401530
.text:0000000000401530                 push    rbp
.text:0000000000401531                 mov     rbp, rsp
.text:0000000000401534                 sub     rsp, 30h
.text:0000000000401538                 call    __main
.text:000000000040153D                 mov     [rbp+x], 1
.text:0000000000401544                 mov     [rbp+y], 1   
.text:000000000040154B                 nop                     ; nop
.text:000000000040154C                 mov     cs:r, 17h       ; 23
.text:0000000000401556                 mov     edx, [rbp+x]
.text:0000000000401559                 mov     eax, [rbp+y]
.text:000000000040155C                 add     eax, edx
.text:000000000040155E                 mov     edx, eax
.text:0000000000401560                 lea     rcx, Format     ; "%d\n"
.text:0000000000401567                 call    printf
.text:000000000040156C                 mov     edx, cs:r
.text:0000000000401572                 mov     eax, cs:k
.text:0000000000401578                 add     eax, edx
.text:000000000040157A                 mov     edx, eax
.text:000000000040157C                 lea     rcx, aD         ; "%d"
.text:0000000000401583                 call    printf
.text:0000000000401588                 mov     eax, 0
.text:000000000040158D                 add     rsp, 30h
.text:0000000000401591                 pop     rbp
.text:0000000000401592                 retn
.text:0000000000401592 main            endp
```

### 成除法
```c
#include<stdio.h>

int main()
{
	int x=30;
	int y=15;
	printf("%d\n",x*y);
	printf("%d\n",x/y);
	printf("%d\n",x%y);
}
```
```
.text:0000000000401530 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:0000000000401530                 public main
.text:0000000000401530 main            proc near               ; CODE XREF: __tmainCRTStartup+233↑p
.text:0000000000401530
.text:0000000000401530 y               = dword ptr -8
.text:0000000000401530 x               = dword ptr -4
.text:0000000000401530
.text:0000000000401530                 push    rbp
.text:0000000000401531                 mov     rbp, rsp
.text:0000000000401534                 sub     rsp, 30h
.text:0000000000401538                 call    __main
.text:000000000040153D                 mov     [rbp+x], 1Eh
.text:0000000000401544                 mov     [rbp+y], 0Fh
.text:000000000040154B                 mov     eax, [rbp+x]
.text:000000000040154E                 imul    eax, [rbp+y]
.text:0000000000401552                 mov     edx, eax
.text:0000000000401554                 lea     rcx, Format     ; "%d\n"
.text:000000000040155B                 call    printf
.text:0000000000401560                 mov     eax, [rbp+x]
.text:0000000000401563                 cdq
.text:0000000000401564                 idiv    [rbp+y]
.text:0000000000401567                 mov     edx, eax
.text:0000000000401569                 lea     rcx, Format     ; "%d\n"
.text:0000000000401570                 call    printf
.text:0000000000401575                 mov     eax, [rbp+x]
.text:0000000000401578                 cdq
.text:0000000000401579                 idiv    [rbp+y]
.text:000000000040157C                 mov     eax, edx        ; 互移動(?)
.text:000000000040157E                 mov     edx, eax        ; 互移動(?)
.text:0000000000401580                 lea     rcx, Format     ; "%d\n"
.text:0000000000401587                 call    printf
.text:000000000040158C                 mov     eax, 0
.text:0000000000401591                 add     rsp, 30h
.text:0000000000401595                 pop     rbp
.text:0000000000401596                 retn
.text:0000000000401596 main            endp
```
>CDQ（Convert Double to Quad的缩写，意为将双字数据扩展为四字），大多出现在除法运算之前. 它实际的作用只是把EDX的所有位都设成EAX最高位的值.
>也就是说,当EAX <80000000, EDX 00000000  （80000000以下是正数，原码0开头）; 当EAX >= 80000000, EDX 则为FFFFFFFF)

### if
```c
#include<stdio.h>

int main()
{
	int x=30;
	int y=15;
	if(x==y)
	{
	 	printf("%d\n",x*y);
	}
	else
	{
		printf("%%%");
	}
	
}
```
```
text:0000000000401530 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:0000000000401530                 public main
.text:0000000000401530 main            proc near               ; CODE XREF: __tmainCRTStartup+233↑p
.text:0000000000401530
.text:0000000000401530 y               = dword ptr -8
.text:0000000000401530 x               = dword ptr -4
.text:0000000000401530
.text:0000000000401530                 push    rbp
.text:0000000000401531                 mov     rbp, rsp
.text:0000000000401534                 sub     rsp, 30h
.text:0000000000401538                 call    __main
.text:000000000040153D                 mov     [rbp+x], 1Eh
.text:0000000000401544                 mov     [rbp+y], 0Fh
.text:000000000040154B                 mov     eax, [rbp+x]
.text:000000000040154E                 cmp     eax, [rbp+y]
.text:0000000000401551                 jnz     short loc_40156A
.text:0000000000401553                 mov     eax, [rbp+x]
.text:0000000000401556                 imul    eax, [rbp+y]
.text:000000000040155A                 mov     edx, eax
.text:000000000040155C                 lea     rcx, Format     ; "%d\n"
.text:0000000000401563                 call    printf
.text:0000000000401568                 jmp     short loc_401576
.text:000000000040156A ; ---------------------------------------------------------------------------
.text:000000000040156A
.text:000000000040156A loc_40156A:                             ; CODE XREF: main+21↑j
.text:000000000040156A                 lea     rcx, asc_404004 ; "%%%"
.text:0000000000401571                 call    printf
.text:0000000000401576
.text:0000000000401576 loc_401576:                             ; CODE XREF: main+38↑j
.text:0000000000401576                 mov     eax, 0
.text:000000000040157B                 add     rsp, 30h
.text:000000000040157F                 pop     rbp
.text:0000000000401580                 retn
.text:0000000000401580 main            endp
```

### for
```c
#include<stdio.h>

int main()
{
	int x=30;
	int y=15;
	for(int a=0;a<10;a++)
	{
	 	printf("%d\n",a);
	}	
}
```
![](https://i.imgur.com/5Vb3tyG.jpg)
### while
skip
### func
#### cdecl
```c
int test(int x,int y,int z);
int a,b,c,ret;
ret=test(a,b,c);
```
```
push c
push b
push a
call test
add esp 12 ; 減少 stack 高度 
mov ret,eax
```
#### stdcall
就不用加上前面的`add esp 12` api的dll 會自己清理stack
#### fastcall
前4個傳到 register 剩下的push 到stack 上 (由右到左)
依照compiler 有所不同
### stack 移動
```c
#include<stdio.h>
int a(int in)
{
	return in+5;
}
int main()
{
	printf("%d\n",a(5));
}

```
![](https://i.imgur.com/Dki45Ht.jpg)
![](https://i.imgur.com/5o98lMM.jpg)
*會因為compiler的設定 asm 有所不同*

### switch
```c
#include<stdio.h>
int main()
{
	int a=5;
	switch(a)
	{
		case 1:
		    printf("%d",a);
		    break;
		case 2:
		    printf("%d",a);
		    break;
		case 3:
		    printf("%d",a);
		    break;
		case 4:
		    printf("%d",a);
		    break;
		case 5:
		    printf("%d",a);
		    break;
	}
}
```
![](https://i.imgur.com/nv1HAgz.jpg)
### 數組
```c
#include<stdio.h>

int main()
{
	int a[5]={0,1,2,3,4};
	for(int i=0;i<5;i++)
	{
	    __asm__("nop");
		a[i]=i;
		__asm__("nop");

	}
}

```
```
.text:0000000000401530 ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:0000000000401530                 public main
.text:0000000000401530 main            proc near               ; CODE XREF: __tmainCRTStartup+233↑p
.text:0000000000401530
.text:0000000000401530 a               = dword ptr -20h
.text:0000000000401530 i               = dword ptr -4
.text:0000000000401530
.text:0000000000401530                 push    rbp
.text:0000000000401531                 mov     rbp, rsp
.text:0000000000401534                 sub     rsp, 40h
.text:0000000000401538                 call    __main
.text:000000000040153D                 mov     [rbp+a], 0
.text:0000000000401544                 mov     [rbp+a+4], 1
.text:000000000040154B                 mov     [rbp+a+8], 2
.text:0000000000401552                 mov     [rbp+a+0Ch], 3
.text:0000000000401559                 mov     [rbp+a+10h], 4
.text:0000000000401560                 mov     [rbp+i], 0
.text:0000000000401567                 jmp     short loc_40157B
.text:0000000000401569 ; ---------------------------------------------------------------------------
.text:0000000000401569
.text:0000000000401569 loc_401569:                             ; CODE XREF: main+4F↓j
.text:0000000000401569                 nop
.text:000000000040156A                 mov     eax, [rbp+i]    ; mov i to eax
.text:000000000040156D                 cdqe
.text:000000000040156F                 mov     edx, [rbp+i]    ; mov i to edx
.text:0000000000401572                 mov     [rbp+rax*4+a], edx
.text:0000000000401576                 nop
.text:0000000000401577                 add     [rbp+i], 1      ; i++
.text:000000000040157B
.text:000000000040157B loc_40157B:                             ; CODE XREF: main+37↑j
.text:000000000040157B                 cmp     [rbp+i], 4
.text:000000000040157F                 jle     short loc_401569
.text:0000000000401581                 mov     eax, 0
.text:0000000000401586                 add     rsp, 40h
.text:000000000040158A                 pop     rbp
.text:000000000040158B                 retn
.text:000000000040158B main            endp
```
### struction
```c
#include<stdio.h>
#include<stdlib.h>
struct my{
	int x[5];
	char y;
	double z;
};
int main()
{
	struct my *g=(my*)malloc(sizeof(struct my));
	g->y='c';
	g->z=0.12;
}
```
![](https://i.imgur.com/3tmZuaD.jpg)
反編譯後 convert struct
### linklist
```c
#include<stdio.h>
#include<stdlib.h>
struct node{
	int x;
	struct node * next;
};
typedef struct node pnode;
int main()
{
	pnode *cu,*head;
	int i;
	head=NULL;
	for(int a=1;1<5;a++)
	{
		cu=(pnode* )malloc(sizeof(pnode));
		cu->x=i;
		cu->next=head;
		head=cu;
	}
}
```
![](https://i.imgur.com/xyd63jA.jpg)
